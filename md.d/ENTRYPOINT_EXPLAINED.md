# üîß MariaDB Entrypoint Script - Explication D√©taill√©e

## üìã Vue d'ensemble

Le fichier `entrypoint.sh` est le **point d'entr√©e** du container MariaDB. Il est ex√©cut√© au d√©marrage du container et a pour responsabilit√©s :

1. ‚úÖ Initialiser la base de donn√©es si elle n'existe pas
2. ‚úÖ Cr√©er les utilisateurs et d√©finir leurs privil√®ges
3. ‚úÖ D√©marrer le serveur MariaDB en mode production

## üèóÔ∏è Architecture G√©n√©rale

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Container MariaDB d√©marre                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Est-ce que /var/lib/mysql/mysql existe ?          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ      OUI        ‚îÇ              NON                   ‚îÇ
‚îÇ  (d√©j√† init)    ‚îÇ         (1√®re fois)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                    ‚îÇ
         ‚îÇ                    ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  1. Initialiser la structure DB     ‚îÇ
         ‚îÇ    ‚îÇ     (mysql_install_db)              ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  2. G√©n√©rer init.sql                ‚îÇ
         ‚îÇ    ‚îÇ     (script init.sh)                ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  3. D√©marrer serveur temporaire     ‚îÇ
         ‚îÇ    ‚îÇ     (mode skip-grant-tables)        ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  4. Cr√©er la base de donn√©es        ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  5. Red√©marrer en mode s√©curis√©     ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  6. Configurer root password        ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  7. Appliquer init.sql              ‚îÇ
         ‚îÇ    ‚îÇ     (cr√©er users, privil√®ges)       ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ                   ‚ñº
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ  8. Nettoyer init.sql (s√©curit√©)    ‚îÇ
         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                             ‚îÇ                         ‚îÇ
                             ‚ñº                         ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
              ‚îÇ  D√©marrer MariaDB (prod)     ‚îÇ        ‚îÇ
              ‚îÇ  exec mysqld                 ‚îÇ        ‚îÇ
              ‚îÇ  (processus principal)       ‚îÇ        ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
                                                       ‚îÇ
```

## üìñ Analyse Ligne par Ligne

### **Phase 0 : Variables et V√©rifications Initiales**

```bash
DATADIR="/var/lib/mysql"
INIT_SQL="/docker-entrypoint-initdb.d/init.sql"
```

**Pourquoi ?**
- `DATADIR` : Emplacement standard o√π MariaDB stocke ses donn√©es
- `INIT_SQL` : Fichier SQL g√©n√©r√© contenant les commandes d'initialisation

---

### **Phase 1 : V√©rification de l'Initialisation**

```bash
if [ ! -d "$DATADIR/mysql" ]; then
    echo "[ENTRYPOINT] Initializing MariaDB data directory..."
    mysql_install_db --datadir="$DATADIR" --user=mysql >/dev/null
fi
```

**Logique :**
- Si le dossier `mysql/` n'existe pas dans `/var/lib/mysql/`
- Alors c'est la **premi√®re fois** que le container d√©marre
- On initialise la structure de la base avec `mysql_install_db`

**R√©sultat :**
- Cr√©ation des tables syst√®me (`mysql.user`, `mysql.db`, etc.)
- Structure de base pour que MariaDB puisse fonctionner

---

### **Phase 2 : G√©n√©ration du Script SQL**

```bash
if [ ! -f "$INIT_SQL" ]; then
    echo "[ENTRYPOINT] init.sql not found, generating a new one..."
    sh /docker-entrypoint-initdb.d/init.sh
```

**Logique :**
- Si `init.sql` n'existe pas encore (ou a √©t√© effac√©)
- Appeler `init.sh` qui g√©n√®re le fichier SQL avec :
  - Mot de passe root
  - Cr√©ation de la base de donn√©es
  - Cr√©ation des utilisateurs applicatifs
  - Attribution des privil√®ges

**Contenu typique d'init.sql :**
```sql
ALTER USER 'root'@'localhost' IDENTIFIED BY 'password';
CREATE DATABASE vsyutkin_inception_db;
CREATE USER 'l0c4l_g0d'@'%' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON vsyutkin_inception_db.* TO 'l0c4l_g0d'@'%';
FLUSH PRIVILEGES;
```

---

### **Phase 3 : D√©marrage Temporaire #1 (Mode Skip-Grant-Tables)**

```bash
mysqld_safe --skip-networking --skip-grant-tables --socket=/var/run/mysqld/mysqld.sock &
MYSQL_PID=$!
```

**Pourquoi ce mode ?**
- `--skip-grant-tables` : Ignore les permissions, permet de se connecter sans mot de passe
- `--skip-networking` : N'√©coute pas sur le r√©seau (s√©curit√© pendant l'init)
- `&` : Lance en arri√®re-plan
- `MYSQL_PID=$!` : Sauvegarde le PID pour pouvoir l'arr√™ter plus tard

**But :**
- Cr√©er la base de donn√©es sans avoir besoin d'authentification
- Temporaire, uniquement pour l'initialisation

---

### **Phase 4 : Attente de la Disponibilit√©**

```bash
_ready=0
for i in {1..30}; do
    if mysqladmin ping -u root --silent; then
        echo "[ENTRYPOINT] MariaDB is ready"
        _ready=1
        break
    fi
    echo "[ENTRYPOINT] Still waiting... attempt $i/30"
    sleep 1
done
```

**Logique :**
- Boucle jusqu'√† 30 secondes
- Teste avec `mysqladmin ping` si le serveur r√©pond
- Si succ√®s : sort de la boucle
- Si √©chec apr√®s 30s : arr√™te tout et signale une erreur

**Pourquoi ?**
- MariaDB prend quelques secondes pour d√©marrer
- Impossible d'ex√©cuter des commandes SQL avant qu'il soit pr√™t

---

### **Phase 5 : Cr√©ation de la Base de Donn√©es**

```bash
mysql --skip-password --protocol=socket -h localhost -e "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\`;"
```

**D√©tails :**
- `--skip-password` : Pas besoin de mot de passe (mode skip-grant-tables)
- `--protocol=socket` : Utilise le socket Unix (plus rapide et s√©curis√©)
- `-e` : Ex√©cute une commande SQL directement

**R√©sultat :**
- Base de donn√©es `vsyutkin_inception_db` cr√©√©e

---

### **Phase 6 : Arr√™t du Serveur Temporaire**

```bash
mysqladmin --skip-password --protocol=socket -h localhost shutdown
```

**Pourquoi ?**
- On doit red√©marrer sans `--skip-grant-tables`
- Pour pouvoir d√©finir le mot de passe root en toute s√©curit√©

---

### **Phase 7 : Red√©marrage #2 (Toujours en Skip-Grant-Tables)**

```bash
mysqld_safe --skip-networking --skip-grant-tables --socket=/var/run/mysqld/mysqld.sock &
```

**But :**
- D√©finir le mot de passe root
- En mode skip-grant-tables pour pouvoir modifier `mysql.global_priv`

---

### **Phase 8 : Configuration du Mot de Passe Root**

```bash
mysql --skip-password --protocol=socket -h localhost <<-EOSQL
    DELETE FROM mysql.user WHERE User='';
    DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
    
    UPDATE mysql.global_priv 
    SET priv=JSON_SET(
        COALESCE(priv,'{}'),
        '$.plugin', 'mysql_native_password',
        '$.authentication_string', CONCAT('*', UPPER(SHA1(UNHEX(SHA1('${MYSQL_ROOT_PASSWORD}')))))
    )
    WHERE User='root';
    
    FLUSH PRIVILEGES;
EOSQL
```

**Explication SQL :**

1. **Nettoyage des utilisateurs anonymes**
   ```sql
   DELETE FROM mysql.user WHERE User='';
   ```
   Supprime les comptes sans nom (s√©curit√©)

2. **Restriction de root**
   ```sql
   DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
   ```
   Root ne peut se connecter que localement

3. **D√©finition du mot de passe**
   ```sql
   UPDATE mysql.global_priv SET priv=JSON_SET(...)
   ```
   - MariaDB 10.11+ utilise `mysql.global_priv` (pas `mysql.user`)
   - Stocke les privil√®ges en JSON
   - Hash le mot de passe avec SHA1 double (m√©thode `mysql_native_password`)

4. **Application des changements**
   ```sql
   FLUSH PRIVILEGES;
   ```
   Recharge les tables de privil√®ges en m√©moire

---

### **Phase 9 : Red√©marrage #3 (Mode Normal avec Authentification)**

```bash
mysqladmin --skip-password --protocol=socket -h localhost shutdown

mysqld_safe --bind-address=0.0.0.0 --port=3306 --user=mysql --datadir=/var/lib/mysql --socket=/var/run/mysqld/mysqld.sock &
```

**Changements :**
- ‚úÖ `--bind-address=0.0.0.0` : √âcoute sur toutes les interfaces r√©seau
- ‚úÖ `--port=3306` : Port standard MySQL
- ‚ùå Plus de `--skip-grant-tables` : Authentification activ√©e

**Pourquoi ?**
- Maintenant que root a un mot de passe, on peut d√©marrer normalement
- Le serveur accepte les connexions r√©seau (pour WordPress)

---

### **Phase 10 : Application de init.sql**

```bash
mysql -u root -p"$MYSQL_ROOT_PASSWORD" --protocol=socket -h localhost < "$INIT_SQL"
```

**Action :**
- Se connecte avec le mot de passe root
- Ex√©cute tout le contenu de `init.sql` :
  - Cr√©ation des utilisateurs (`l0c4l_g0d`)
  - Attribution des privil√®ges
  - Configuration des acc√®s r√©seau

---

### **Phase 11 : Nettoyage du Fichier SQL**

```bash
echo "" > $INIT_SQL
```

**S√©curit√© :**
- Efface le contenu de `init.sql` (contient des mots de passe en clair)
- Le fichier vide servira de "marqueur" : s'il existe (m√™me vide), on ne refait pas l'init

---

### **Phase 12 : D√©marrage Production**

```bash
echo "[ENTRYPOINT] Starting MariaDB..."
rm -f /var/run/mysqld/mysqld.pid

exec mysqld \
    --user=mysql \
    --datadir=/var/lib/mysql \
    --bind-address=0.0.0.0 \
    --port=3306 \
    --socket=/var/run/mysqld/mysqld.sock
```

**Important : `exec`**
- Remplace le processus du shell par `mysqld`
- `mysqld` devient le **PID 1** du container
- Quand `mysqld` s'arr√™te, le container s'arr√™te
- Respecte les bonnes pratiques Docker (pas de processus parent inutile)

**Configuration :**
- `--user=mysql` : Tourne avec l'utilisateur non-root `mysql`
- `--bind-address=0.0.0.0` : Accessible depuis le r√©seau Docker
- `--port=3306` : Port standard
- `--socket=...` : Socket Unix pour connexions locales

---

## üîÑ Diagramme de Flux Simplifi√©

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Container d√©marre                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ DB existe ?     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ NON    ‚îÇ OUI
         ‚îÇ        ‚îÇ
         ‚ñº        ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ INITIALISATION         ‚îÇ
    ‚îÇ                        ‚îÇ
    ‚îÇ 1. mysql_install_db    ‚îÇ
    ‚îÇ 2. G√©n√©rer init.sql    ‚îÇ
    ‚îÇ 3. Serveur temp #1     ‚îÇ
    ‚îÇ 4. CREATE DATABASE     ‚îÇ
    ‚îÇ 5. Arr√™t               ‚îÇ
    ‚îÇ 6. Serveur temp #2     ‚îÇ
    ‚îÇ 7. SET root password   ‚îÇ
    ‚îÇ 8. Arr√™t               ‚îÇ
    ‚îÇ 9. Serveur temp #3     ‚îÇ
    ‚îÇ 10. Appliquer init.sql ‚îÇ
    ‚îÇ 11. Effacer init.sql   ‚îÇ
    ‚îÇ 12. Arr√™t              ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  PRODUCTION            ‚îÇ
    ‚îÇ  exec mysqld           ‚îÇ
    ‚îÇ  (PID 1, foreground)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Concepts Cl√©s

### **1. Idempotence**
Le script peut √™tre ex√©cut√© plusieurs fois sans probl√®me :
- Si la DB existe d√©j√† ‚Üí skip l'initialisation
- Si `init.sql` existe (vide) ‚Üí skip la configuration

### **2. S√©curit√©**
- Suppression des utilisateurs anonymes
- Restriction de root √† localhost seulement
- Effacement de `init.sql` apr√®s utilisation
- Pas de mot de passe en clair dans les logs

### **3. Mode Skip-Grant-Tables**
- Permet de bootstrapper la s√©curit√©
- Utilis√© UNIQUEMENT pendant l'init
- Jamais expos√© sur le r√©seau (`--skip-networking`)

### **4. PID 1 et `exec`**
- Le dernier `exec mysqld` remplace le shell
- `mysqld` devient le processus principal du container
- Garantit que les signaux (SIGTERM) sont correctement g√©r√©s
- Conforme aux best practices Docker

---

## ‚ö†Ô∏è Points d'Attention

### **Erreurs Possibles**

1. **Timeout pendant l'attente**
   ```
   MariaDB did not become ready in time
   ```
   ‚Üí Le serveur n'a pas d√©marr√© en 30s (disque lent, RAM insuffisante)

2. **Erreur de connexion**
   ```
   Connection failed
   ```
   ‚Üí Socket non accessible, permissions incorrectes

3. **√âchec de cr√©ation de DB**
   ```
   Failed to create database
   ```
   ‚Üí Nom de DB invalide, ou probl√®me de permissions

### **Volume Persistence**

Le dossier `/var/lib/mysql` est mont√© en volume :
- **Avantage** : Les donn√©es persistent entre red√©marrages
- **Cons√©quence** : L'initialisation ne se fait qu'UNE FOIS
- Pour r√©initialiser : `make fclean` ou `make reinit`

---

## üîç Debug et Logs

Le script inclut beaucoup de `echo` :
```bash
docker logs inception_mariadb
```

Vous verrez chaque √©tape :
- `[ENTRYPOINT] Initializing MariaDB data directory...`
- `[ENTRYPOINT] MariaDB is ready`
- `[ENTRYPOINT] Setting root password...`
- etc.

---

## üìö Commandes Utiles pour Comprendre

```bash
# Voir le processus principal du container
docker top inception_mariadb

# Entrer dans le container
docker exec -it inception_mariadb bash

# V√©rifier que mysqld est bien PID 1
ps aux

# Voir les fichiers de la DB
ls -la /var/lib/mysql/

# V√©rifier le socket
ls -la /var/run/mysqld/mysqld.sock
```

---

## üéì R√©sum√©

Le script `entrypoint.sh` orchestre l'initialisation compl√®te d'un serveur MariaDB s√©curis√© :

1. ‚úÖ D√©tecte si c'est la premi√®re fois
2. ‚úÖ Initialise la structure de base
3. ‚úÖ Configure root avec un mot de passe
4. ‚úÖ Cr√©e la base de donn√©es applicative
5. ‚úÖ Cr√©e les utilisateurs avec privil√®ges
6. ‚úÖ Nettoie les secrets temporaires
7. ‚úÖ D√©marre en production avec `exec`

**R√©sultat final :**
- Serveur MariaDB s√©curis√©
- Base de donn√©es pr√™te
- Utilisateurs configur√©s
- Accessible par WordPress via le r√©seau Docker
- Processus principal (PID 1) pour une gestion propre du container
